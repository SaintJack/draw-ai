# 儿童简笔画 AI 画图 APP 技术设计文档

## 1. 文档概述

### 1.1 文档目的
本文档详细描述儿童简笔画 AI 画图 APP 的技术架构、实现方案和开发规范，基于 **React Native** 技术栈开发，确保项目能够成功发布到 Android 平台（未来可扩展至 iOS）。

### 1.2 适用范围
- **主要平台**：Android（API Level 21+，Android 5.0+）
- **扩展平台**：iOS（可选）
- **目标设备**：平板电脑、手机
- **开发团队**：React Native 开发、Node.js 后端开发、AI 算法

### 1.3 技术栈概览（已确定：React Native）

**核心技术栈**：
- **前端框架**：React Native + TypeScript
- **UI 库**：React Native Paper / React Native Elements
- **状态管理**：Zustand
- **导航**：React Navigation
- **本地存储**：AsyncStorage + react-native-sqlite-storage
- **网络请求**：Axios
- **绘图引擎**：react-native-svg + react-native-canvas
- **语音识别**：@react-native-voice/voice
- **后端服务**：Node.js + Express（AI 解析服务）
- **构建工具**：React Native CLI / Expo（可选）

---

## 1.4 技术方案选型对比

### 方案一：原生 Android 开发（Kotlin）

**技术栈**：
- **前端框架**：Kotlin + Jetpack Compose（或 Android View 系统）
- **架构模式**：MVVM + Clean Architecture
- **AI 服务**：大语言模型 API（受限 Prompt）
- **本地存储**：Room Database + SharedPreferences
- **网络**：Retrofit + OkHttp
- **绘图引擎**：Canvas API + 自定义 View
- **语音识别**：Android Speech Recognition API

**优点**：
- ✅ 性能最优，直接调用系统 API
- ✅ 完整的 Android 生态支持
- ✅ 最佳的用户体验和流畅度
- ✅ 可以充分利用硬件加速

**缺点**：
- ❌ 需要 Android 开发经验
- ❌ 仅支持 Android 平台
- ❌ 开发周期相对较长

**适用场景**：团队有 Android 开发经验，追求最佳性能和体验

---

### 方案二：React Native（推荐用于 JS/TS 技术栈）

**技术栈**：
- **前端框架**：React Native + TypeScript
- **UI 库**：React Native Paper / NativeBase
- **状态管理**：Zustand / Redux Toolkit
- **本地存储**：AsyncStorage + SQLite（react-native-sqlite-storage）
- **网络**：Axios / Fetch API
- **绘图引擎**：react-native-svg + react-native-canvas 或自定义 Canvas
- **语音识别**：@react-native-voice/voice
- **后端服务**：Node.js + Express（可选）

**优点**：
- ✅ 使用 JavaScript/TypeScript，学习曲线平缓
- ✅ 跨平台（Android + iOS）
- ✅ 热更新支持
- ✅ 丰富的第三方库生态
- ✅ 可以用 Node.js 开发后端服务

**缺点**：
- ❌ 性能略低于原生（但足够用）
- ❌ 部分原生功能需要桥接
- ❌ 包体积相对较大

**适用场景**：团队熟悉 JavaScript/TypeScript，需要跨平台支持

**示例项目结构**：
```
draw-ai-rn/
├── src/
│   ├── components/      # React 组件
│   ├── screens/         # 页面
│   ├── services/        # API 服务
│   ├── store/           # 状态管理
│   └── utils/           # 工具函数
├── android/             # Android 原生代码
├── ios/                 # iOS 原生代码（可选）
└── server/              # Node.js 后端（可选）
    ├── routes/          # API 路由
    ├── services/        # AI 解析服务
    └── models/          # 数据模型
```

---

### 方案三：Capacitor + Web 技术栈

**技术栈**：
- **前端框架**：React / Vue / Angular + TypeScript
- **UI 库**：Material-UI / Ant Design
- **打包工具**：Capacitor
- **本地存储**：IndexedDB + Capacitor Preferences
- **网络**：Axios / Fetch API
- **绘图引擎**：Fabric.js / Konva.js / Paper.js
- **语音识别**：Web Speech API + Capacitor 插件
- **后端服务**：Node.js + Express

**优点**：
- ✅ 完全使用 Web 技术栈
- ✅ 一套代码多端运行（Web + Android + iOS）
- ✅ 开发效率高，调试方便
- ✅ 可以用 Node.js 开发完整后端

**缺点**：
- ❌ 性能相对较低（但可接受）
- ❌ 部分原生功能受限
- ❌ 需要 WebView 容器

**适用场景**：团队熟悉 Web 开发，需要快速迭代

---

### 方案四：Node.js 后端 + PWA（渐进式 Web 应用）

**技术栈**：
- **前端**：React / Vue + TypeScript
- **后端**：Node.js + Express / Fastify
- **数据库**：SQLite / PostgreSQL
- **AI 服务**：Node.js 调用 LLM API
- **存储**：IndexedDB（浏览器）+ 服务器存储
- **绘图引擎**：Canvas API / SVG
- **语音识别**：Web Speech API

**优点**：
- ✅ 完全基于 Web 技术
- ✅ 无需应用商店审核
- ✅ 可以安装到主屏幕（PWA）
- ✅ 后端完全用 Node.js 开发

**缺点**：
- ❌ 需要浏览器支持
- ❌ 离线能力有限
- ❌ 性能受浏览器限制

**适用场景**：快速原型，或作为 Web 应用发布

---

### 技术方案对比表

| 特性 | 原生 Android | React Native | Capacitor | PWA |
|------|-------------|--------------|-----------|-----|
| **开发语言** | Kotlin | JavaScript/TS | JavaScript/TS | JavaScript/TS |
| **性能** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| **跨平台** | ❌ | ✅ | ✅ | ✅ |
| **开发效率** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **原生功能** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ |
| **学习曲线** | 陡峭 | 平缓 | 平缓 | 平缓 |
| **Node.js 后端** | 可选 | ✅ | ✅ | ✅ |
| **包体积** | 小 | 中 | 中 | 小 |

---

### 已确定方案：React Native ✅

**项目已确定使用 React Native 技术栈**，理由：
- ✅ 使用 JavaScript/TypeScript，学习曲线平缓
- ✅ 可以用 Node.js 开发后端服务
- ✅ 跨平台支持（Android + iOS）
- ✅ 性能足够满足需求
- ✅ 开发效率高，热更新支持
- ✅ 丰富的第三方库生态

**本文档后续章节均基于 React Native 技术栈进行设计。**

---

## 2. 系统架构设计

### 2.1 整体架构（React Native）

```
┌─────────────────────────────────────────────────────────┐
│              React Native 客户端（Android/iOS）          │
├─────────────────────────────────────────────────────────┤
│  Presentation Layer (React Components)                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  画布界面     │  │  语音输入     │  │  作品管理     │  │
│  │ (Canvas)     │  │ (VoiceInput) │  │ (Gallery)    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
├─────────────────────────────────────────────────────────┤
│  State Management (Zustand)                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  DrawingStore│  │  HistoryStore│  │  VoiceStore  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
├─────────────────────────────────────────────────────────┤
│  Service Layer (业务逻辑)                                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  AIService   │  │  StorageService│ │  VoiceService│  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
├─────────────────────────────────────────────────────────┤
│  Data Layer (数据层)                                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  HTTP Client │  │  SQLite DB  │  │  AsyncStorage│  │
│  │  (Axios)     │  │             │  │              │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                          ↕ HTTPS
┌─────────────────────────────────────────────────────────┐
│              Node.js 后端服务（必需）                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  Express API │  │  LLM Service │  │  Data Sync   │  │
│  │  (Routes)    │  │  (AI Parse)  │  │  (Optional)  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 核心数据流

```
用户输入（语音/文字）
    ↓
[语音识别] → 文本
    ↓
[本地预处理] → 清理、规范化
    ↓
[AI 解析服务] → 结构化绘图指令（JSON）
    ↓
[指令验证] → 校验格式、安全性
    ↓
[绘图引擎] → 渲染图形到画布
    ↓
[历史记录] → 保存操作到本地数据库
```

---

## 3. React Native 技术选型

### 3.1 开发语言与框架

| 技术项 | 选型 | 理由 |
|--------|------|------|
| **开发语言** | TypeScript | 类型安全，提升代码质量 |
| **UI 框架** | React Native | 跨平台，声明式 UI |
| **状态管理** | Zustand | 轻量、简单、性能好 |
| **导航** | React Navigation | React Native 官方推荐 |
| **UI 组件库** | React Native Paper | Material Design，组件丰富 |
| **异步处理** | async/await + Promise | JavaScript 原生异步方案 |

### 3.2 核心依赖（package.json）

```json
{
  "dependencies": {
    "react": "18.2.0",
    "react-native": "0.72.0",
    "@react-navigation/native": "^6.1.0",
    "@react-navigation/stack": "^6.3.0",
    "react-native-paper": "^5.11.0",
    "react-native-svg": "^13.14.0",
    "react-native-canvas": "^0.1.38",
    "@react-native-voice/voice": "^4.0.0",
    "@react-native-async-storage/async-storage": "^1.19.0",
    "react-native-sqlite-storage": "^6.0.1",
    "axios": "^1.6.0",
    "zustand": "^4.4.0",
    "react-native-gesture-handler": "^2.14.0",
    "react-native-reanimated": "^3.6.0",
    "react-native-safe-area-context": "^4.8.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.0",
    "@types/react-native": "^0.72.0",
    "typescript": "^5.3.0",
    "@babel/core": "^7.23.0",
    "@babel/preset-env": "^7.23.0",
    "@babel/preset-typescript": "^7.23.0"
  }
}
```

### 3.3 最低系统要求

- **Android 版本**：API Level 21 (Android 5.0 Lollipop)
- **iOS 版本**：iOS 12.0+（如支持 iOS）
- **最低 RAM**：2GB（推荐 3GB+）
- **屏幕尺寸**：5 英寸以上（平板体验更佳）
- **网络**：首次使用需要网络（AI 解析），后续可部分离线
- **Node.js 版本**：18.0+（开发环境）

---

## 4. 模块设计

### 4.1 模块划分（React Native 项目结构）

```
draw-ai-rn/
├── src/
│   ├── components/          # React 组件
│   │   ├── Canvas/          # 画布组件
│   │   │   ├── DrawingCanvas.tsx
│   │   │   └── ShapeRenderer.tsx
│   │   ├── VoiceInput/      # 语音输入组件
│   │   │   └── VoiceButton.tsx
│   │   ├── Toolbar/         # 工具栏组件
│   │   │   └── DrawingToolbar.tsx
│   │   └── Gallery/         # 作品集组件
│   │       └── GalleryItem.tsx
│   ├── screens/              # 页面组件
│   │   ├── DrawingScreen.tsx
│   │   ├── GalleryScreen.tsx
│   │   └── SettingsScreen.tsx
│   ├── services/            # 业务服务
│   │   ├── aiService.ts     # AI 解析服务
│   │   ├── storageService.ts # 存储服务
│   │   └── voiceService.ts  # 语音识别服务
│   ├── store/               # 状态管理（Zustand）
│   │   ├── drawingStore.ts
│   │   ├── historyStore.ts
│   │   └── voiceStore.ts
│   ├── models/              # 数据模型
│   │   ├── Shape.ts
│   │   ├── Drawing.ts
│   │   └── History.ts
│   ├── utils/               # 工具函数
│   │   ├── drawingEngine.ts
│   │   └── helpers.ts
│   └── navigation/          # 导航配置
│       └── AppNavigator.tsx
├── server/                  # Node.js 后端（可选但推荐）
│   ├── src/
│   │   ├── routes/          # API 路由
│   │   │   └── ai.routes.ts
│   │   ├── services/        # 业务服务
│   │   │   └── llmService.ts
│   │   └── app.ts           # Express 应用
│   └── package.json
├── android/                 # Android 原生代码
├── ios/                     # iOS 原生代码（可选）
├── package.json
└── tsconfig.json
```

### 4.2 核心模块详细设计

#### 4.2.1 画布模块（Canvas Module）

**职责**：
- 渲染图形
- 处理触摸交互（绘制、拖动、缩放、删除）
- 管理图形状态

**技术实现**：
```typescript
// src/components/Canvas/DrawingCanvas.tsx
import React from 'react';
import { View, StyleSheet, GestureResponderEvent } from 'react-native';
import Svg, { Circle, Rect, Line, Path } from 'react-native-svg';
import { useDrawingStore } from '../../store/drawingStore';
import { Shape } from '../../models/Shape';

export const DrawingCanvas: React.FC = () => {
  const { shapes, updateShapePosition, deleteShape } = useDrawingStore();

  const handleTouchStart = (event: GestureResponderEvent, shapeId: string) => {
    // 处理拖动开始
  };

  const renderShape = (shape: Shape) => {
    switch (shape.type) {
      case 'circle':
        return (
          <Circle
            key={shape.id}
            cx={shape.x}
            cy={shape.y}
            r={shape.radius}
            stroke="black"
            strokeWidth={3}
            fill="none"
            onPress={() => handleShapePress(shape.id)}
          />
        );
      case 'rectangle':
        return (
          <Rect
            key={shape.id}
            x={shape.x}
            y={shape.y}
            width={shape.width}
            height={shape.height}
            stroke="black"
            strokeWidth={3}
            fill="none"
            onPress={() => handleShapePress(shape.id)}
          />
        );
      case 'line':
        return (
          <Line
            key={shape.id}
            x1={shape.points[0].x}
            y1={shape.points[0].y}
            x2={shape.points[1].x}
            y2={shape.points[1].y}
            stroke="black"
            strokeWidth={3}
          />
        );
      default:
        return null;
    }
  };

  return (
    <View style={styles.container}>
      <Svg style={styles.canvas}>
        {shapes.map(renderShape)}
      </Svg>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  canvas: {
    flex: 1,
  },
});
```

**关键组件/类**：
- `DrawingCanvas`：画布主组件
- `ShapeRenderer`：图形渲染器
- `useDrawingStore`：Zustand 状态管理 Hook

#### 4.2.2 AI 解析模块（AI Parser Module）

**职责**：
- 调用后端 Node.js API（调用大语言模型）
- 将自然语言转换为结构化绘图指令
- 处理模糊指代（"这个""那个"）

**API 接口设计**：
```typescript
// src/services/aiService.ts
import axios from 'axios';
import { Shape } from '../models/Shape';

const API_BASE_URL = process.env.API_BASE_URL || 'http://localhost:3000/api';

export interface ParseRequest {
  text: string;
  context: {
    shapes: Shape[];
    recentActions: string[];
  };
}

export interface ParseResponse {
  action: 'add' | 'update' | 'delete';
  shape?: {
    type: string;
    properties: Record<string, any>;
  };
  targetId?: string;  // 用于 update/delete
}

export const aiService = {
  async parseCommand(request: ParseRequest): Promise<ParseResponse> {
    try {
      const response = await axios.post<ParseResponse>(
        `${API_BASE_URL}/v1/parse`,
        request,
        {
          timeout: 5000,
          headers: {
            'Content-Type': 'application/json',
          },
        }
      );
      return response.data;
    } catch (error) {
      console.error('AI parse error:', error);
      // 降级处理：返回默认图形
      return {
        action: 'add',
        shape: {
          type: 'circle',
          properties: { radius: 50 },
        },
      };
    }
  },
};
```

**后端 Prompt 设计**（Node.js 服务端，受限，仅用于绘画）：
```typescript
// server/src/services/llmService.ts
const prompt = `你是一个简笔画助手，只能将儿童的自然语言转换为绘图指令。
输入：${text}
当前画布：${JSON.stringify(context.shapes)}
输出：JSON 格式的绘图指令，只能包含以下动作：
- add: 添加新图形
- update: 修改已有图形（通过 targetId）
- delete: 删除图形

只返回 JSON，不要其他内容。`;
```

#### 4.2.3 绘图引擎模块（Drawing Engine）

**职责**：
- 执行结构化绘图指令
- 生成图形对象
- 应用简笔画风格（轻微抖动）

**图形类型定义**：
```typescript
// src/models/Shape.ts
export interface Point {
  x: number;
  y: number;
}

export interface ShapeStyle {
  strokeWidth: number;
  strokeColor: string;
  jitter: number;  // 抖动系数
}

export type ShapeType = 'circle' | 'rectangle' | 'line' | 'point';

export interface BaseShape {
  id: string;
  type: ShapeType;
  position: Point;
  style: ShapeStyle;
}

export interface Circle extends BaseShape {
  type: 'circle';
  radius: number;
}

export interface Rectangle extends BaseShape {
  type: 'rectangle';
  width: number;
  height: number;
}

export interface Line extends BaseShape {
  type: 'line';
  points: Point[];
}

export interface PointShape extends BaseShape {
  type: 'point';
}

export type Shape = Circle | Rectangle | Line | PointShape;

// 默认样式
export const defaultShapeStyle: ShapeStyle = {
  strokeWidth: 3,
  strokeColor: '#000000',
  jitter: 0.02,
};
```

**绘图引擎实现**：
```typescript
// src/utils/drawingEngine.ts
import { Shape, ShapeStyle, Point } from '../models/Shape';
import { ParseResponse } from '../services/aiService';

export class DrawingEngine {
  // 应用抖动效果（简笔画风格）
  static applyJitter(value: number, jitter: number): number {
    const randomOffset = (Math.random() - 0.5) * jitter * value;
    return value + randomOffset;
  }

  // 根据 AI 指令创建图形
  static createShapeFromInstruction(
    instruction: ParseResponse,
    canvasSize: { width: number; height: number }
  ): Shape | null {
    if (!instruction.shape) return null;

    const centerX = canvasSize.width / 2;
    const centerY = canvasSize.height / 2;
    const id = `shape_${Date.now()}_${Math.random()}`;

    switch (instruction.shape.type) {
      case 'circle':
        return {
          id,
          type: 'circle',
          position: {
            x: this.applyJitter(centerX, 0.1),
            y: this.applyJitter(centerY, 0.1),
          },
          radius: instruction.shape.properties.radius || 50,
          style: {
            strokeWidth: 3,
            strokeColor: '#000000',
            jitter: 0.02,
          },
        };
      case 'rectangle':
        return {
          id,
          type: 'rectangle',
          position: {
            x: this.applyJitter(centerX - 50, 0.1),
            y: this.applyJitter(centerY - 50, 0.1),
          },
          width: instruction.shape.properties.width || 100,
          height: instruction.shape.properties.height || 100,
          style: {
            strokeWidth: 3,
            strokeColor: '#000000',
            jitter: 0.02,
          },
        };
      // ... 其他图形类型
      default:
        return null;
    }
  }
}
```

#### 4.2.4 语音识别模块（Speech Recognition）

**职责**：
- 调用 React Native Voice 库
- 处理识别结果
- 支持儿童语音特征（不完整、重复）

**实现**：
```typescript
// src/services/voiceService.ts
import Voice from '@react-native-voice/voice';
import { useEffect, useState, useCallback } from 'react';

export const useVoiceRecognition = () => {
  const [isRecording, setIsRecording] = useState(false);
  const [result, setResult] = useState<string>('');
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // 初始化语音识别
    Voice.onSpeechStart = () => {
      setIsRecording(true);
      setError(null);
    };

    Voice.onSpeechEnd = () => {
      setIsRecording(false);
    };

    Voice.onSpeechResults = (e) => {
      if (e.value && e.value.length > 0) {
        // 取第一个识别结果
        setResult(e.value[0]);
      }
    };

    Voice.onSpeechError = (e) => {
      console.error('Speech error:', e);
      setError(e.error?.message || '语音识别错误');
      setIsRecording(false);
    };

    Voice.onSpeechPartialResults = (e) => {
      // 实时显示部分结果
      if (e.value && e.value.length > 0) {
        setResult(e.value[0]);
      }
    };

    return () => {
      Voice.destroy().then(Voice.removeAllListeners);
    };
  }, []);

  const startListening = useCallback(async () => {
    try {
      await Voice.start('zh-CN');
    } catch (err) {
      console.error('Start listening error:', err);
      setError('无法启动语音识别');
    }
  }, []);

  const stopListening = useCallback(async () => {
    try {
      await Voice.stop();
    } catch (err) {
      console.error('Stop listening error:', err);
    }
  }, []);

  const cancelListening = useCallback(async () => {
    try {
      await Voice.cancel();
    } catch (err) {
      console.error('Cancel listening error:', err);
    }
  }, []);

  return {
    isRecording,
    result,
    error,
    startListening,
    stopListening,
    cancelListening,
  };
};
```

**使用示例**：
```typescript
// src/components/VoiceInput/VoiceButton.tsx
import React from 'react';
import { Button } from 'react-native-paper';
import { useVoiceRecognition } from '../../services/voiceService';

export const VoiceButton: React.FC = () => {
  const { isRecording, result, startListening, stopListening } = useVoiceRecognition();

  const handlePress = () => {
    if (isRecording) {
      stopListening();
    } else {
      startListening();
    }
  };

  return (
    <Button
      mode="contained"
      onPress={handlePress}
      icon={isRecording ? 'microphone' : 'microphone-off'}
    >
      {isRecording ? '停止录音' : '开始录音'}
    </Button>
  );
};
```

---

## 5. 数据模型设计

### 5.1 核心数据模型（TypeScript）

```typescript
// src/models/Drawing.ts
export interface Drawing {
  id: string;
  title: string;
  createdAt: number;
  updatedAt: number;
  thumbnailPath?: string;
}

// src/models/Shape.ts（已在 4.2.3 中定义）
// Shape 类型定义...

// src/models/History.ts
export interface HistoryEntry {
  id: string;
  drawingId: string;
  action: 'add' | 'update' | 'delete' | 'manual';
  shapeId?: string;
  timestamp: number;
  data?: any;  // 操作数据快照
}
```

### 5.2 存储方案（SQLite + AsyncStorage）

**SQLite 数据库配置**：
```typescript
// src/services/storageService.ts
import SQLite from 'react-native-sqlite-storage';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { Drawing, Shape, HistoryEntry } from '../models';

// 初始化数据库
SQLite.DEBUG(true);
SQLite.enablePromise(true);

const database_name = 'DrawAI.db';
const database_version = '1.0';
const database_displayname = 'DrawAI SQLite Database';
const database_size = 200000;

export class StorageService {
  private db: SQLite.SQLiteDatabase | null = null;

  async initDatabase(): Promise<void> {
    try {
      this.db = await SQLite.openDatabase({
        name: database_name,
        location: 'default',
      });

      // 创建表
      await this.createTables();
    } catch (error) {
      console.error('Database init error:', error);
      throw error;
    }
  }

  private async createTables(): Promise<void> {
    if (!this.db) return;

    // 创建 drawings 表
    await this.db.executeSql(`
      CREATE TABLE IF NOT EXISTS drawings (
        id TEXT PRIMARY KEY,
        title TEXT,
        createdAt INTEGER,
        updatedAt INTEGER,
        thumbnailPath TEXT
      )
    `);

    // 创建 shapes 表
    await this.db.executeSql(`
      CREATE TABLE IF NOT EXISTS shapes (
        id TEXT PRIMARY KEY,
        drawingId TEXT,
        type TEXT,
        data TEXT,
        createdAt INTEGER,
        zIndex INTEGER,
        FOREIGN KEY (drawingId) REFERENCES drawings(id)
      )
    `);

    // 创建 history 表
    await this.db.executeSql(`
      CREATE TABLE IF NOT EXISTS history (
        id TEXT PRIMARY KEY,
        drawingId TEXT,
        action TEXT,
        shapeId TEXT,
        timestamp INTEGER,
        data TEXT,
        FOREIGN KEY (drawingId) REFERENCES drawings(id)
      )
    `);
  }

  // Drawing 操作
  async saveDrawing(drawing: Drawing): Promise<void> {
    if (!this.db) throw new Error('Database not initialized');

    await this.db.executeSql(
      `INSERT OR REPLACE INTO drawings (id, title, createdAt, updatedAt, thumbnailPath)
       VALUES (?, ?, ?, ?, ?)`,
      [drawing.id, drawing.title, drawing.createdAt, drawing.updatedAt, drawing.thumbnailPath || null]
    );
  }

  async getDrawings(): Promise<Drawing[]> {
    if (!this.db) throw new Error('Database not initialized');

    const [results] = await this.db.executeSql('SELECT * FROM drawings ORDER BY updatedAt DESC');
    const drawings: Drawing[] = [];

    for (let i = 0; i < results.rows.length; i++) {
      drawings.push(results.rows.item(i));
    }

    return drawings;
  }

  async deleteDrawing(id: string): Promise<void> {
    if (!this.db) throw new Error('Database not initialized');

    await this.db.executeSql('DELETE FROM drawings WHERE id = ?', [id]);
    await this.db.executeSql('DELETE FROM shapes WHERE drawingId = ?', [id]);
    await this.db.executeSql('DELETE FROM history WHERE drawingId = ?', [id]);
  }

  // Shape 操作
  async saveShapes(drawingId: string, shapes: Shape[]): Promise<void> {
    if (!this.db) throw new Error('Database not initialized');

    // 先删除旧的 shapes
    await this.db.executeSql('DELETE FROM shapes WHERE drawingId = ?', [drawingId]);

    // 插入新的 shapes
    for (const shape of shapes) {
      await this.db.executeSql(
        `INSERT INTO shapes (id, drawingId, type, data, createdAt, zIndex)
         VALUES (?, ?, ?, ?, ?, ?)`,
        [
          shape.id,
          drawingId,
          shape.type,
          JSON.stringify(shape),
          Date.now(),
          0,
        ]
      );
    }
  }

  async getShapes(drawingId: string): Promise<Shape[]> {
    if (!this.db) throw new Error('Database not initialized');

    const [results] = await this.db.executeSql(
      'SELECT * FROM shapes WHERE drawingId = ? ORDER BY zIndex',
      [drawingId]
    );

    const shapes: Shape[] = [];
    for (let i = 0; i < results.rows.length; i++) {
      const row = results.rows.item(i);
      shapes.push(JSON.parse(row.data));
    }

    return shapes;
  }

  // History 操作
  async saveHistory(entry: HistoryEntry): Promise<void> {
    if (!this.db) throw new Error('Database not initialized');

    await this.db.executeSql(
      `INSERT INTO history (id, drawingId, action, shapeId, timestamp, data)
       VALUES (?, ?, ?, ?, ?, ?)`,
      [
        entry.id,
        entry.drawingId,
        entry.action,
        entry.shapeId || null,
        entry.timestamp,
        entry.data ? JSON.stringify(entry.data) : null,
      ]
    );

    // 限制历史记录数量（最多 20 条）
    await this.db.executeSql(
      `DELETE FROM history 
       WHERE drawingId = ? 
       AND id NOT IN (
         SELECT id FROM history 
         WHERE drawingId = ? 
         ORDER BY timestamp DESC 
         LIMIT 20
       )`,
      [entry.drawingId, entry.drawingId]
    );
  }

  async getHistory(drawingId: string): Promise<HistoryEntry[]> {
    if (!this.db) throw new Error('Database not initialized');

    const [results] = await this.db.executeSql(
      'SELECT * FROM history WHERE drawingId = ? ORDER BY timestamp DESC LIMIT 20',
      [drawingId]
    );

    const history: HistoryEntry[] = [];
    for (let i = 0; i < results.rows.length; i++) {
      const row = results.rows.item(i);
      history.push({
        ...row,
        data: row.data ? JSON.parse(row.data) : undefined,
      });
    }

    return history;
  }
}

// 单例
export const storageService = new StorageService();
```

**AsyncStorage 用于简单配置**：
```typescript
// src/utils/storage.ts
import AsyncStorage from '@react-native-async-storage/async-storage';

export const preferences = {
  async set(key: string, value: any): Promise<void> {
    await AsyncStorage.setItem(key, JSON.stringify(value));
  },

  async get<T>(key: string): Promise<T | null> {
    const value = await AsyncStorage.getItem(key);
    return value ? JSON.parse(value) : null;
  },

  async remove(key: string): Promise<void> {
    await AsyncStorage.removeItem(key);
  },
};
```

---

## 6. UI/UX 设计

### 6.1 界面结构

```
MainActivity
├── 画布界面（主界面）
│   ├── 顶部工具栏
│   │   ├── 语音输入按钮
│   │   ├── 文字输入按钮
│   │   ├── 撤销/重做
│   │   └── 保存按钮
│   ├── 画布区域（Canvas）
│   └── 底部操作栏
│       ├── 手动绘制模式切换
│       └── 图形选择（圆、矩形、线等）
└── 侧边栏（可选）
    ├── 作品集
    └── 设置
```

### 6.2 交互设计要点

1. **大按钮设计**：适合儿童手指操作，按钮尺寸 ≥ 48dp
2. **即时反馈**：所有操作都有视觉/动画反馈
3. **容错设计**：误操作可撤销，无破坏性操作
4. **简化导航**：减少层级，主要功能一键直达

### 6.3 动画设计

```typescript
// 使用 react-native-reanimated
import Animated, {
  useSharedValue,
  useAnimatedStyle,
  withTiming,
  withRepeat,
  withSequence,
} from 'react-native-reanimated';

// 图形出现动画
const scale = useSharedValue(0.8);

const animatedStyle = useAnimatedStyle(() => {
  return {
    transform: [{ scale: scale.value }],
  };
});

// 启动动画
useEffect(() => {
  scale.value = withRepeat(
    withSequence(
      withTiming(1.0, { duration: 300 }),
      withTiming(0.8, { duration: 300 })
    ),
    -1,
    true
  );
}, []);

// 绘制过程动画
const animateDrawing = (shape: Shape, duration: number = 500) => {
  const progress = useSharedValue(0);
  
  useEffect(() => {
    progress.value = withTiming(1, { duration });
  }, []);
  
  // 根据 progress 逐步绘制图形
};
```

---

## 7. 性能优化

### 7.1 渲染优化

- **Canvas 优化**：使用硬件加速，避免过度重绘
- **图形缓存**：已绘制的图形缓存为 Bitmap
- **分层渲染**：背景层、图形层、交互层分离

### 7.2 网络优化

- **请求去重**：相同请求 500ms 内不重复发送
- **本地缓存**：常用指令结果缓存
- **离线降级**：网络失败时使用本地规则引擎

### 7.3 内存优化

- **图片压缩**：导出时压缩，不保存原始大图
- **历史记录限制**：最多保存 20 步，超出自动清理
- **数据库清理**：定期清理过期作品

---

## 8. 安全与合规

### 8.1 数据安全

- **本地存储加密**：敏感数据使用 Android Keystore 加密
- **网络传输**：所有 API 调用使用 HTTPS
- **权限最小化**：仅申请必要权限（录音、存储）

### 8.2 儿童隐私保护

- **不采集个人信息**：不收集姓名、年龄、位置等
- **本地优先**：数据优先存储在本地
- **家长控制**：提供家长模式，可查看/删除作品

### 8.3 权限申请

**AndroidManifest.xml**（已在 14.2 中配置）：
```xml
<uses-permission android:name="android.permission.RECORD_AUDIO" />
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" 
    android:maxSdkVersion="32" />
<uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
```

**运行时权限申请（React Native）**：
```typescript
// src/utils/permissions.ts
import { Platform, PermissionsAndroid } from 'react-native';

export const requestPermissions = async (): Promise<boolean> => {
  if (Platform.OS === 'android') {
    try {
      const granted = await PermissionsAndroid.requestMultiple([
        PermissionsAndroid.PERMISSIONS.RECORD_AUDIO,
        PermissionsAndroid.PERMISSIONS.WRITE_EXTERNAL_STORAGE,
        PermissionsAndroid.PERMISSIONS.READ_MEDIA_IMAGES,
      ]);

      return (
        granted['android.permission.RECORD_AUDIO'] ===
          PermissionsAndroid.RESULTS.GRANTED &&
        (granted['android.permission.WRITE_EXTERNAL_STORAGE'] ===
          PermissionsAndroid.RESULTS.GRANTED ||
          granted['android.permission.READ_MEDIA_IMAGES'] ===
            PermissionsAndroid.RESULTS.GRANTED)
      );
    } catch (err) {
      console.warn('Permission request error:', err);
      return false;
    }
  }
  return true; // iOS 权限在 Info.plist 中配置
};
```

**使用示例**：
```typescript
// src/components/VoiceInput/VoiceButton.tsx
import { useEffect, useState } from 'react';
import { Alert } from 'react-native';
import { requestPermissions } from '../../utils/permissions';

export const VoiceButton: React.FC = () => {
  const [hasPermission, setHasPermission] = useState(false);

  useEffect(() => {
    checkPermissions();
  }, []);

  const checkPermissions = async () => {
    const granted = await requestPermissions();
    if (!granted) {
      Alert.alert(
        '权限被拒绝',
        '需要录音权限才能使用语音功能',
        [{ text: '确定' }]
      );
    }
    setHasPermission(granted);
  };

  // ...
};
```

---

## 9. 部署方案

### 9.1 React Native 构建配置

**package.json**：
```json
{
  "name": "draw-ai-rn",
  "version": "1.0.0",
  "scripts": {
    "android": "react-native run-android",
    "android:release": "cd android && ./gradlew assembleRelease",
    "android:bundle": "cd android && ./gradlew bundleRelease",
    "ios": "react-native run-ios",
    "start": "react-native start",
    "test": "jest",
    "lint": "eslint ."
  }
}
```

**Android 构建配置**（android/app/build.gradle）：
```gradle
android {
    compileSdkVersion 34
    buildToolsVersion "34.0.0"

    defaultConfig {
        applicationId "com.drawai.kids"
        minSdkVersion 21
        targetSdkVersion 34
        versionCode 1
        versionName "1.0.0"
    }

    buildTypes {
        release {
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
            signingConfig signingConfigs.release
        }
    }

    signingConfigs {
        release {
            if (project.hasProperty('MYAPP_RELEASE_STORE_FILE')) {
                storeFile file(MYAPP_RELEASE_STORE_FILE)
                storePassword MYAPP_RELEASE_STORE_PASSWORD
                keyAlias MYAPP_RELEASE_KEY_ALIAS
                keyPassword MYAPP_RELEASE_KEY_PASSWORD
            }
        }
    }
}
```

**gradle.properties**（签名配置）：
```properties
MYAPP_RELEASE_STORE_FILE=keystore.jks
MYAPP_RELEASE_KEY_ALIAS=drawai
MYAPP_RELEASE_STORE_PASSWORD=your_store_password
MYAPP_RELEASE_KEY_PASSWORD=your_key_password
```

### 9.2 构建命令

```bash
# 开发环境运行
npm run android

# 构建 Release APK
npm run android:release

# 构建 Release AAB（Google Play 推荐）
npm run android:bundle

# 输出位置：
# APK: android/app/build/outputs/apk/release/app-release.apk
# AAB: android/app/build/outputs/bundle/release/app-release.aab
```

### 9.3 发布流程

1. **本地测试**：
   ```bash
   npm run android:release
   # 安装到设备测试
   ```

2. **内部测试**：使用 Google Play Internal Testing
   - 上传 AAB 文件
   - 添加测试用户

3. **Beta 测试**：Google Play Closed Testing
   - 扩大测试范围
   - 收集反馈

4. **正式发布**：Google Play Store
   - 完善应用信息
   - 上传截图和描述
   - 提交审核

### 9.4 版本管理

- **版本号规则**：主版本.次版本.修订版本（如 1.0.0）
- **版本更新**：
  - 支持 OTA 更新（可选，使用 CodePush）
  - 应用内提示更新
- **兼容性**：向后兼容至少 2 个主版本

### 9.5 Node.js 后端部署（可选但推荐）

**部署选项**：
1. **云服务**：AWS、Azure、Google Cloud
2. **容器化**：Docker + Kubernetes
3. **Serverless**：Vercel、Netlify Functions

**示例 Dockerfile**：
```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .

EXPOSE 3000

CMD ["node", "server/src/app.js"]
```

---

## 10. 测试策略

### 10.1 单元测试

- ViewModel 逻辑测试
- 绘图引擎测试
- 数据模型转换测试

### 10.2 UI 测试

- Compose UI 测试
- 触摸交互测试
- 语音识别集成测试

### 10.3 性能测试

- 启动时间 < 2 秒
- 首次出图 < 2 秒
- 修改操作 < 500ms
- 内存占用 < 200MB

---

## 11. 开发计划

### 11.1 MVP 版本（V1.0）

**时间**：6-8 周

**任务清单**：
1. 项目搭建（1 周）
   - React Native 项目初始化
   - TypeScript 配置
   - 依赖安装（React Navigation、Zustand、SVG 等）
   - 基础架构搭建（目录结构、路由配置）

2. 画布模块（2 周）
   - react-native-svg 集成
   - 基础图形渲染（圆、矩形、线）
   - 触摸交互（拖动、缩放、删除）
   - 图形状态管理（Zustand）

3. AI 解析模块（2 周）
   - Node.js 后端搭建（Express）
   - LLM API 集成
   - 前端 API 调用（Axios）
   - 指令解析与验证
   - 错误处理与降级

4. 语音识别（1 周）
   - @react-native-voice/voice 集成
   - 语音输入 UI 组件
   - 文本预处理
   - 权限管理

5. 数据存储（1 周）
   - SQLite 数据库配置
   - AsyncStorage 配置
   - 作品保存/加载功能
   - 历史记录管理

6. 测试与优化（1 周）
   - 功能测试
   - 性能优化（渲染优化、内存管理）
   - Bug 修复
   - Android 打包测试

### 11.2 里程碑

- **Week 1**：完成项目搭建和基础架构
- **Week 3**：完成画布基础功能
- **Week 5**：完成 AI 解析集成（前后端）
- **Week 7**：完成核心功能开发
- **Week 8**：发布 MVP 版本到 Google Play

### 11.3 开发环境要求

- **Node.js**：18.0+
- **npm/yarn**：最新版本
- **Android Studio**：最新版本（用于 Android 开发）
- **Java JDK**：11 或更高版本
- **Android SDK**：API Level 21+
- **设备/模拟器**：Android 5.0+ 设备或模拟器

---

## 12. 风险与应对

### 12.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| AI API 响应慢 | 用户体验差 | 本地缓存 + 超时降级 |
| 语音识别准确率低 | 儿童表达理解困难 | 多轮确认 + 文字输入备选 |
| 内存占用过高 | 低端设备卡顿 | 图形数量限制 + 内存监控 |

### 12.2 合规风险

- **儿童隐私法规**：严格遵守 COPPA、GDPR-K
- **应用商店审核**：提前准备隐私政策、使用条款

---

## 13. 后续扩展（V1.5+）

- 离线 AI 模型（端侧推理）
- 更多图形类型（曲线、多边形）
- 主题模板（人物、动物、植物）
- 作品分享社区
- 家长控制台

---

## 14. 附录

### 14.1 参考资源

- [React Native 官方文档](https://reactnative.dev)
- [React Navigation 文档](https://reactnavigation.org)
- [Zustand 文档](https://github.com/pmndrs/zustand)
- [React Native SVG 文档](https://github.com/react-native-svg/react-native-svg)
- [React Native Voice 文档](https://github.com/react-native-voice/voice)
- [Node.js 官方文档](https://nodejs.org)
- [Express.js 文档](https://expressjs.com)

### 14.2 关键配置文件示例

**AndroidManifest.xml**（React Native）：
```xml
<!-- android/app/src/main/AndroidManifest.xml -->
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.RECORD_AUDIO" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" 
        android:maxSdkVersion="32" />
    <uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />

    <application
        android:name=".MainApplication"
        android:label="@string/app_name"
        android:icon="@mipmap/ic_launcher"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:allowBackup="false"
        android:theme="@style/AppTheme">
        
        <activity
            android:name=".MainActivity"
            android:label="@string/app_name"
            android:configChanges="keyboard|keyboardHidden|orientation|screenLayout|screenSize|uiMode"
            android:launchMode="singleTask"
            android:windowSoftInputMode="adjustResize"
            android:exported="true"
            android:screenOrientation="portrait">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
```

**tsconfig.json**：
```json
{
  "compilerOptions": {
    "target": "esnext",
    "module": "commonjs",
    "lib": ["es2017"],
    "allowJs": true,
    "jsx": "react-native",
    "noEmit": true,
    "isolatedModules": true,
    "strict": true,
    "moduleResolution": "node",
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "resolveJsonModule": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "babel.config.js", "metro.config.js"]
}
```

**babel.config.js**：
```javascript
module.exports = {
  presets: ['module:metro-react-native-babel-preset'],
  plugins: [
    [
      'module-resolver',
      {
        root: ['./src'],
        extensions: ['.ios.js', '.android.js', '.js', '.ts', '.tsx', '.json'],
        alias: {
          '@': './src',
        },
      },
    ],
  ],
};
```

---

## 15. 快速开始指南（完整代码示例）

本章节提供完整的代码示例和项目初始化步骤，帮助快速开始开发。

### 15.1 项目初始化

```bash
# 创建 React Native 项目
npx react-native init DrawAI --template react-native-template-typescript

# 安装核心依赖
npm install @react-navigation/native @react-navigation/stack
npm install react-native-svg react-native-canvas
npm install @react-native-voice/voice
npm install @react-native-async-storage/async-storage
npm install react-native-sqlite-storage
npm install axios zustand

# iOS 依赖（如果支持 iOS）
cd ios && pod install
```

### 15.2 项目结构

```
draw-ai-rn/
├── src/
│   ├── components/
│   │   ├── Canvas/
│   │   │   ├── DrawingCanvas.tsx
│   │   │   └── ShapeRenderer.tsx
│   │   ├── VoiceInput/
│   │   │   └── VoiceButton.tsx
│   │   └── Toolbar/
│   │       └── DrawingToolbar.tsx
│   ├── screens/
│   │   ├── DrawingScreen.tsx
│   │   └── GalleryScreen.tsx
│   ├── services/
│   │   ├── aiService.ts      # AI 解析服务
│   │   ├── storageService.ts  # 本地存储
│   │   └── voiceService.ts    # 语音识别
│   ├── store/
│   │   ├── drawingStore.ts    # Zustand 状态管理
│   │   └── historyStore.ts
│   ├── models/
│   │   ├── Shape.ts
│   │   └── Drawing.ts
│   └── utils/
│       └── drawingEngine.ts
├── server/                    # Node.js 后端（可选）
│   ├── src/
│   │   ├── routes/
│   │   │   └── ai.routes.ts
│   │   ├── services/
│   │   │   └── llmService.ts
│   │   └── app.ts
│   └── package.json
├── android/
├── ios/
└── package.json
```

### 15.3 核心代码示例

#### 15.3.1 画布组件（React Native）

```typescript
// src/components/Canvas/DrawingCanvas.tsx
import React, { useRef, useEffect } from 'react';
import { View, StyleSheet } from 'react-native';
import { Canvas, Path, Circle, Rect } from 'react-native-svg';
import { useDrawingStore } from '../../store/drawingStore';

export const DrawingCanvas: React.FC = () => {
  const { shapes } = useDrawingStore();
  
  return (
    <View style={styles.container}>
      <Canvas style={styles.canvas}>
        {shapes.map(shape => {
          switch (shape.type) {
            case 'circle':
              return (
                <Circle
                  key={shape.id}
                  cx={shape.x}
                  cy={shape.y}
                  r={shape.radius}
                  stroke="black"
                  strokeWidth={3}
                  fill="none"
                />
              );
            case 'rectangle':
              return (
                <Rect
                  key={shape.id}
                  x={shape.x}
                  y={shape.y}
                  width={shape.width}
                  height={shape.height}
                  stroke="black"
                  strokeWidth={3}
                  fill="none"
                />
              );
            // ... 其他图形类型
          }
        })}
      </Canvas>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  canvas: {
    flex: 1,
  },
});
```

#### 15.3.2 状态管理（Zustand）

```typescript
// src/store/drawingStore.ts
import create from 'zustand';
import { Shape } from '../models/Shape';

interface DrawingState {
  shapes: Shape[];
  currentDrawingId: string | null;
  addShape: (shape: Shape) => void;
  updateShape: (id: string, updates: Partial<Shape>) => void;
  deleteShape: (id: string) => void;
  undo: () => void;
  redo: () => void;
}

export const useDrawingStore = create<DrawingState>((set, get) => ({
  shapes: [],
  currentDrawingId: null,
  history: [],
  historyIndex: -1,
  
  addShape: (shape) => {
    set((state) => ({
      shapes: [...state.shapes, shape],
      history: [...state.history, { type: 'add', shape }],
      historyIndex: state.historyIndex + 1,
    }));
  },
  
  updateShape: (id, updates) => {
    set((state) => ({
      shapes: state.shapes.map(s => 
        s.id === id ? { ...s, ...updates } : s
      ),
    }));
  },
  
  deleteShape: (id) => {
    set((state) => ({
      shapes: state.shapes.filter(s => s.id !== id),
    }));
  },
  
  undo: () => {
    // 撤销逻辑
  },
  
  redo: () => {
    // 重做逻辑
  },
}));
```

#### 15.3.3 AI 服务（调用后端 API）

```typescript
// src/services/aiService.ts
import axios from 'axios';
import { Shape } from '../models/Shape';

const API_BASE_URL = 'http://your-backend-url.com/api';

export interface ParseRequest {
  text: string;
  context: {
    shapes: Shape[];
    recentActions: string[];
  };
}

export interface ParseResponse {
  action: 'add' | 'update' | 'delete';
  shape?: {
    type: string;
    properties: Record<string, any>;
  };
  targetId?: string;
}

export const aiService = {
  async parseCommand(request: ParseRequest): Promise<ParseResponse> {
    try {
      const response = await axios.post<ParseResponse>(
        `${API_BASE_URL}/v1/parse`,
        request,
        {
          timeout: 5000,
          headers: {
            'Content-Type': 'application/json',
          },
        }
      );
      return response.data;
    } catch (error) {
      console.error('AI parse error:', error);
      // 降级处理：返回默认图形
      return {
        action: 'add',
        shape: {
          type: 'circle',
          properties: { radius: 50 },
        },
      };
    }
  },
};
```

#### 15.3.4 语音识别服务

```typescript
// src/services/voiceService.ts
import Voice from '@react-native-voice/voice';
import { useEffect, useState } from 'react';

export const useVoiceRecognition = () => {
  const [isRecording, setIsRecording] = useState(false);
  const [result, setResult] = useState<string>('');

  useEffect(() => {
    Voice.onSpeechStart = () => setIsRecording(true);
    Voice.onSpeechEnd = () => setIsRecording(false);
    Voice.onSpeechResults = (e) => {
      if (e.value && e.value.length > 0) {
        setResult(e.value[0]);
      }
    };
    Voice.onSpeechError = (e) => {
      console.error('Speech error:', e);
      setIsRecording(false);
    };

    return () => {
      Voice.destroy().then(Voice.removeAllListeners);
    };
  }, []);

  const startListening = async () => {
    try {
      await Voice.start('zh-CN');
    } catch (error) {
      console.error('Start listening error:', error);
    }
  };

  const stopListening = async () => {
    try {
      await Voice.stop();
    } catch (error) {
      console.error('Stop listening error:', error);
    }
  };

  return {
    isRecording,
    result,
    startListening,
    stopListening,
  };
};
```

### 15.4 Node.js 后端服务（可选）

```typescript
// server/src/routes/ai.routes.ts
import express from 'express';
import { llmService } from '../services/llmService';

const router = express.Router();

router.post('/v1/parse', async (req, res) => {
  try {
    const { text, context } = req.body;
    
    // 调用 LLM API
    const instruction = await llmService.parseToDrawingInstruction(
      text,
      context
    );
    
    res.json(instruction);
  } catch (error) {
    console.error('Parse error:', error);
    // 返回默认指令，不暴露错误
    res.json({
      action: 'add',
      shape: {
        type: 'circle',
        properties: { radius: 50 },
      },
    });
  }
});

export default router;
```

```typescript
// server/src/services/llmService.ts
import axios from 'axios';

const LLM_API_URL = process.env.LLM_API_URL || 'https://api.openai.com/v1/chat/completions';
const LLM_API_KEY = process.env.LLM_API_KEY;

export const llmService = {
  async parseToDrawingInstruction(
    text: string,
    context: any
  ): Promise<any> {
    const prompt = `你是一个简笔画助手，只能将儿童的自然语言转换为绘图指令。
输入：${text}
当前画布：${JSON.stringify(context.shapes)}
输出：JSON 格式的绘图指令，只能包含以下动作：
- add: 添加新图形
- update: 修改已有图形（通过 targetId）
- delete: 删除图形

只返回 JSON，不要其他内容。`;

    const response = await axios.post(
      LLM_API_URL,
      {
        model: 'gpt-3.5-turbo',
        messages: [
          {
            role: 'system',
            content: '你是一个简笔画助手，只能输出 JSON 格式的绘图指令。',
          },
          {
            role: 'user',
            content: prompt,
          },
        ],
        temperature: 0.3,
        max_tokens: 200,
      },
      {
        headers: {
          'Authorization': `Bearer ${LLM_API_KEY}`,
          'Content-Type': 'application/json',
        },
      }
    );

    const content = response.data.choices[0].message.content;
    return JSON.parse(content);
  },
};
```

### 15.5 package.json 配置

```json
{
  "name": "draw-ai-rn",
  "version": "1.0.0",
  "scripts": {
    "android": "react-native run-android",
    "ios": "react-native run-ios",
    "start": "react-native start",
    "server": "cd server && npm run dev"
  },
  "dependencies": {
    "react": "18.2.0",
    "react-native": "0.72.0",
    "@react-navigation/native": "^6.1.0",
    "react-native-svg": "^13.14.0",
    "@react-native-voice/voice": "^4.0.0",
    "@react-native-async-storage/async-storage": "^1.19.0",
    "axios": "^1.6.0",
    "zustand": "^4.4.0"
  }
}
```

### 15.6 Android 权限配置

```xml
<!-- android/app/src/main/AndroidManifest.xml -->
<manifest>
  <uses-permission android:name="android.permission.INTERNET" />
  <uses-permission android:name="android.permission.RECORD_AUDIO" />
  <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
  
  <application>
    <!-- ... -->
  </application>
</manifest>
```

---

## 16. 总结

本文档基于 **React Native + Node.js** 技术栈，完整描述了儿童简笔画 AI 画图 APP 的技术设计。

### 核心技术栈
- ✅ **前端**：React Native + TypeScript
- ✅ **状态管理**：Zustand
- ✅ **绘图引擎**：react-native-svg
- ✅ **语音识别**：@react-native-voice/voice
- ✅ **本地存储**：SQLite + AsyncStorage
- ✅ **后端服务**：Node.js + Express（AI 解析）

### 关键特性
- 跨平台支持（Android + iOS）
- 完整的代码示例
- 详细的架构设计
- 可执行的开发计划

### 下一步
1. 按照第 15 章快速开始指南初始化项目
2. 参考各模块设计实现核心功能
3. 按照开发计划逐步完成 MVP 版本

---

**文档版本**：2.0（React Native 版本）  
**技术栈**：React Native + TypeScript + Node.js  
**最后更新**：2024年  
**维护者**：开发团队
